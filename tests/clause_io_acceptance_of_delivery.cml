model clause_io_acceptance_of_delivery

role shipper

role receiver

value payment     tez from receiver to shipper

value deliveryDate date

value businessDays day

(* extra blockchain incentives *)
value incentiveR  tez from receiver = payment

value incentiveS  tez from receiver = 0.2 * payment

%traceable (payment + incentiveR) (receiver)
%traceable (incentiveS) (shipper)

states =
 | Created initial
 | Aborted
 | Signed
 | Delivered
 | Success
 | Fail

transaction[%signedbyall [shipper, receiver]] sign = {
   condition : check (payment + incentiveR + incentiveS);
   transition from Created to Signed;
}

transition unilateral_abort from Created to Aborted = {
   called by shipper or receiver;
   action : transfer back incentiveR,
            transfer back payment,
            transfer back incentiveS;
}

transition[%signedbyall [shipper, receiver]] abort from Signed to Aborted = {
   called by shipper or receiver;
   action : transfer back incentiveR,
            transfer back payment,
            transfer back incentiveS;
}

transaction confirm = {
  called by receiver;
  transition from Signed to Delivered;
  action :
       deliveryDate := now (),
       transfer back incentiveR,
       transfer payment,
       transfer back incentiveS;
}

transition success from Delivered to Success = {
  called by shipper;
  condition : after (deliverydate + businessDays)
}

transition fail from Delivered to Fail = {
  called by receiver;
  condition : before (deliverydate + businessDays)
}
