model zero_coupon_bond_with_insurance

role issuer = @tz1KksC8RvjUWAbXYJuNrUbontHGor25Cztk (* seller ‘Alice’ *)

role owner = @tz1KmuhR6P52hw6xs5P69BXJYAURaznhvN1k
(* buyer ‘Bob’; receives 11 tez in one-year *)

contract insurance = {
   transaction pay : address tez
} = @KT1GabhR5P52hw6xs5P69BXJYAURaznhvN1k

variable price tez from owner = 10

variable payment tez from issuer to owner = 11 * price

variable maturity date

states =
 | Created initial
 | Insured (* Guarantee Fund has accepted issuer *)
 | Confirmed (* owner has purchased bond *)
 | Repaid (* issuer has transferred payment to contract *)
 | Collected (* owner has collected payment *)

transaction insured = {
  called by insurance
  transition from Created to Insured
}

transaction confirm = {
  condition transferred = price
  specification
    balance = 0
  transition from Insured to Confirmed
  action
    maturity := now + 1Y;
    transfer price to issuer
 }


transaction repay = {
  called by issuer
  transition from Confirmed to Repaid
  condition transferred = payment
}

transaction collect = {
  called by owner
  condition now > maturity
  transition from Repaid to Collected
  action
    if balance >= payment
    then transfer balance to owner
    else guarantee_fund.pay owner payment
}
